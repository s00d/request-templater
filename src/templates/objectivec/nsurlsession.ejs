<% const { url, method, mimeType, headers, postData, cookies } = locals; %>
// Construct the request URL
NSString *fullUrl = @"<%- url %>";

// Set up the request headers
NSMutableDictionary *headers = [NSMutableDictionary dictionary];
<% headers.forEach(header => { %>
[headers setObject:@"<%= header.value %>" forKey:@"<%= header.name %>"];
<% }) %>

// Add cookies to the request
<% cookies.forEach(cookie => { %>
NSDictionary *cookieProperties = @{
    NSHTTPCookieDomain: @"<%= cookie.domain %>",
    NSHTTPCookiePath: @"<%= cookie.path %>",
    NSHTTPCookieName: @"<%= cookie.name %>",
    NSHTTPCookieValue: @"<%= cookie.value %>",
};
NSHTTPCookie *cookie = [NSHTTPCookie cookieWithProperties:cookieProperties];
[[NSHTTPCookieStorage sharedHTTPCookieStorage] setCookie:cookie];
<% }) %>

// Set up the request parameters
NSMutableDictionary *parameters = [NSMutableDictionary dictionary];
<% postData.forEach(param => { %>
[parameters setObject:@"<%= param.value %>" forKey:@"<%= param.name %>"];
<% }) %>

// Create the request
NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:[NSURL URLWithString:fullUrl]];
request.HTTPMethod = @"<%= method %>";
[request setValue:@"<%= mimeType %>" forHTTPHeaderField:@"Content-Type"];
for (NSString *key in headers) {
    [request setValue:headers[key] forHTTPHeaderField:key];
}
NSURLSessionConfiguration *config = [NSURLSessionConfiguration defaultSessionConfiguration];
NSURLSession *session = [NSURLSession sessionWithConfiguration:config];

// Add the parameters to the request body
if (parameters.count > 0) {
    NSData *bodyData = [[parameters urlEncodedString] dataUsingEncoding:NSUTF8StringEncoding];
    request.HTTPBody = bodyData;
}

// Send the request
NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
    if (error) {
        NSLog(@"Error: %@", error);
        return;
    }
    if ([response isKindOfClass:[NSHTTPURLResponse class]]) {
        NSHTTPURLResponse *httpResponse = (NSHTTPURLResponse *)response;
        if (httpResponse.statusCode == 200) {
            NSString *responseString = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
            NSLog(@"Response: %@", responseString);
        }
    }
}];
[task resume];
